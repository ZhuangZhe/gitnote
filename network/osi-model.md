# OSI模型

* 应用层: 为用户的应用进程程序提供服务。
* 运输层: 运输层的任务就是负责向两个主机中**进程之间**的通信提供服务，支持复用和分用，只要有两个协议:
  * `TCP`: 传输控制协议
    * 面向连接
    * 数据传输的基本单位是报文段
    * 提供可靠交付
  * `UDP`: 用户数据包协议
    * 无连接
    * 数据传输的基本单位是用户数据报
    * 提供尽最大努力交付
* 网络层: 负责为分组交换网上的不同主机提供通信服务，在发送数据时，网络层把运输层产生的报文段或用户数据报封装成分组或包进行传送。
* 数据链路层: 数据链路层将网络层交下来的IP数据报组装成帧，在两个相邻结点间的链路上透明地传送帧中的数据，每一帧包括数据和必要的控制信息。
* 物理层: 透明地传送比特流。

## 各层的作用和支持的协议

| 分层 | 作用 | 数据类型 | 协议 |
| :--- | :--- | :--- | :--- |
| `物理层` | 通过媒介传输比特，确定机械及电气规范 | bit: 比特 | `RJ45`、`CLOCK`、`IEEE802.3` |
| `数据链路层` | 将比特组装成帧和点到点的传递 | Frame: 帧 | `PPP`、`FR`、`HDLC`、`VLAN`、`MAC` |
| `网络层` | 负责数据包从源到宿的传递和网际 | Packet: 包 | `IP`、`ICMP`、`ARP`、`RARP`、`OSPF`、`IPX`、`RIP` |
| `运输层` | 提供端到端的可靠报文传递和错误回复 | Segment: 段 | `TCP`、`UDP`、`SPX` |
| `会话层` | 建立、管理和终止会话 | SPDU: 会话协议数据单元 | `NFS`、`SQL`、`NETBIOS`、`RPC` |
| `表示层` | 对数据进行翻译、加密和压缩 | PPDU: 表示协议数据单元 | `JPEG`、`MPEG`、`ASII` |
| `应用层` | 允许访问OSI环境的手段 | APDU: 应用协议数据单元 | `FTP`、`DNS`、`Telnet`、`SMTP`、`HTTP`、`WWW`、`NFS` |

## 物理层

* 传输数据: 比特流
* 数据传输系统: 源系统\(`发送器`\) -&gt; 传输系统 -&gt; 目的系统\(`接收器`\)
* 通道
  * 单向通道\(单工\)
  * 双向交替通信\(半双工\)
  * 双向同时通信\(全双工\)
* 通道复用技术
  * 频分复用: 不同用户在不同频带
  * 时分复用: 不同用户在同一时间段的不同时间片
  * 波分复用: 光的频分复用
  * 码分复用: 不同用户使用不同的码

## 数据链路层

* 主要信道
  * 点对点信道
    * 传输数据: 帧
    * 基本功能
      * 封装成帧: 把网络层的IP数据报封装成帧。
      * 透明传输: 可以通过字节填充方法，不管数据部分什么字符都能传输出去。
      * 差错检测: 广泛使用CRC\(循环冗余检测\)降低误码率。
    * PPP\(点对点协议\): 用户计算机和ISP通信时所使用的协议
  * 广播信道
    * 单播: 收到的帧的 MAC 地址与本站的硬件地址相同
    * 广播: 发送给本局域网上所有站点的帧
    * 多播: 发送给本局域网上一部分站点的帧

## 网络层

* IP网际协议: 为计算机网络相互连接进行通信而设计的协议。
  * IP地址: `网络号` + `主机号`
  * IP地址分类

    | 地址类别 | 网络号 | 网络范围 | 主机号 | IP地址范围 |
    | :--- | :--- | :--- | :--- | :--- |
    | A类 | 8 bits，第一位固定为0 | 0 - 127 | 24 bits | 1.0.0.0 - 127.255.255.255 |
    | B类 | 16 bits，前两位固定为10 | 128.0 - 191.255 | 16 bits | 128.0.0.0 - 191.255.255.255 |
    | C类 | 24 bits，前三位固定为110 | 192.0.0 - 223.255.255 | 8 bits | 192.0.0.0 - 223.255.255.255 |
    | D类 | 前四位固定为1110，后面为多播地址 |  |  |  |
    | E类 | 前五位固定为11110，后面保留今后再用 |  |  | ｜ |

  * IP数据报格式
    * 首部
      * 固定部分
        * 版本\(4 bits\)
        * 首部长度\(4 bits\)
        * 服务类型\(8 bits\)
        * 总长度\(16 bits\)
        * 标识\(16 bits\)
        * 标志\(3 bits\)
        * 片偏移\(13 bits\)
        * 生存时间\(8 bits\)
        * 协议\(8 bits\)
        * 首部检检验和\(16 bits\)
        * 源地址\(32 bits\)
        * 目的地址\(32 bits\)
      * 可变部分
    * 数据部分
* `ICMP`网际控制报文协议
  * `ICMP`报文格式
    * 首部
      * 类型\(8 bits\)
      * 代码\(8 bits\)
      * 校验和\(16 bits\)
      * 首部其他部分\(32 bits\)
    * 数据
  * `PING`\(分组网间探测\): 测试两个主机之间的连通性
  * `TTL`\(生存时间\): 该字段指定IP包被路由器丢弃之前允许通过的最大网段数量
* 内部网关协议
  * `RIP`路由信息协议
  * `OSPF`开放最短路径优先
* 外部网关协议
  * `BGP`边界网关协议
* IP多播
  * `IGMP`网际组管理协议
* `VPN`虚拟专用网
* `NAT`网络地址转换
* 路由表存储的数据
  * 网络ID
  * 子网掩码
  * 下一跳地址/接口
  * 路由表可能含有如下附加信息
    * 花费
    * 路由的服务质量
    * 路由中需要过滤的出/入连接列表

## 传输层

* `TCP`
  * Transmission Control Protocol，传输控制协议
  * 特点
    * 面向连接
    * 只能点对点通信
    * 可靠交互
    * 全双工通信
    * 面向字节流
  * `TCP`如何保证可靠传输
    * 确认和超时重传
    * 数据合理分片和排序
    * 流量控制
    * 拥塞控制
    * 数据校验
  * `TCP`报文结构
    * 首部
      * 源端口
      * 目的端口
      * 序号
      * 确认好
      * 数据偏移
      * 保留
      * `TCP` Flag\(共6bits\)
        * URG: 紧急比特，为1时，代表该封包为紧急封包，应尽快传送。
        * ACK: 确认比特，为1时，代表这个封包为确认封包。
        * PSH: 为1时，代表要求对方立即传送缓冲区内的其他对应封包，而无需等缓冲满了才送。
        * RST: 表明`TCP`连接中出现严重差错，必须释放连接，然后再重新建立运输连接。
        * SYN: 同步比特，为1时，表示这是一个连接请求或连接接受报文。
        * FIN: 终止比特，为1时，表明此报文段的发送端的数据已发送完毕，并要求释放传输连接。
      * 窗口
      * 检验和
      * 紧急指针
      * TCP选项
    * 数据
* `UDP`
  * User Datagram Protocol，用户数据报协议
  * 特点
    * 无连接
    * 尽最大努力交付
    * 面向报文
    * 没有拥塞控制
    * 支持一对一、一对多、多对多的交互通信
    * 首部开销小
  * `UDP`报文结构
    * 首部
      * 伪首部
        * 源IP地址
        * 目的IP地址
        * 0
        * 17
        * `UDP`长度
      * 源端口
      * 目的端口
      * 长度
      * 校验和
* `TCP`的黏包问题
  * 原因: `TCP`是一个基于字节流的传输服务，所传输的数据是没有边界的。
  * 解决方法: 发送定长包，包头加上包体长度，添加特殊符号划清边界。
* `TCP`流量控制
  * 方法: 利用可变窗口进行流量控制，服务端收到数据之后，在回文中告诉客户端接下来还能发多少信息。
* `TCP`拥塞控制
  * 概念: 拥塞控制就是防止过多的数据注入到网络中，可以使网络中的路由器或链路不致过载。
  * 解决方法
    * slow-start\(慢启动\)
    * congestion avoidance\(拥塞避免\)
    * fast retransmit\(快重传\)
    * fast recovery\(快恢复\)
* `TCP`三次握手
  1. B的`TCP`服务器进程首先创建传输控制块`TCB`,准备接受客户进程的连接请求。然后服务器进程就处于`LISTEN(收听)`状态，等待客户的连接请求。如有，就做出响应。
  2. A的`TCP`客户进程也是首先创建传输控制模块`TCB`，然后向B发出连接请求报文段，这时首部中的同步位`SYN = 1`，同时选择一个初始序号`seq = x`。`TCP`规定，`SYN`报文段不能携带数据，但是要消耗一个序号。这时，`TCP`客户进程进入`SYN-SENT(同步已发送)`状态。
  3. B收到连接请求报文段后，如同意建立连接，则向A发送确认。在确认报文段中应把`SYN`和`ACK`位都置1，确认号是`ack = x + 1`,同时也为自己选择一个初始序号`seq = y`。注意：这个报文段也不能携带数据，但同样要消耗一个序号。这时TCP服务器进程进入`SYN-RECV(同步收到)`状态。
  4. `TCP`客户进程收到B的确认后，还要向B给出确认。确认报文段的`ACK`置1，确认号`ack = y + 1`，而自己的序号`seq = x + 1`。`TCP`标准规定，`ACK`报文段可以携带数据。但如果不携带数据则不消耗序号。在这种情况下，下一个数据报文段的序号仍然是`seq = x + 1`。这时，`TCP`的连接已经建立，A进入`ESTABLISHED(已建立连接)`状态。当B接收到A的确认后，B也进入`ESTABLISHED(已建立连接)`状态。
* `TCP`四次挥手
  1. A和B都处于`ESTABLISHED`状态，A的应用进程首先向其`TCP`发出连接释放报文段，并停止再发送数据，主动关闭TCP连接。A把连接释放报文段首部的`FIN`置1，其序列号`seq = u`，它等于前面已经传送过的数据的最后一个字节的序号加1。这时，A进入`FIN-WAIT-1(终止等待1)`状态，等待B的确认。注意：TCP规定：FIN报文段即使不携带数据，它也会消耗一个序号。
  2. B收到连接释放报文段后即发出确认，确认号是`ack = u + 1`，而这个报文段自己的序号是v，等待B前面已经传送过的数据的最后一个字节的序号加1。然后B就进入`CLOSE-WAIT(关闭等待)`状态。`TCP`服务器进程这时应通知高层应用进程，因而从A到B这个方向的连接就释放了，这时的`TCP`连接处于半关闭状态，即A已经没有数据要发送了，但B若发送数据，A仍要接收。也就是说，从B到A这个方向的连接并没有关闭，这个连接可能会持续一段时间。
  3. A收到来自B的确认后，就进入`FIN-WAIT-2(终止等待2)`状态，等待B发出的连接释放报文段。如果B已经没有要向A发送的数据，其应用进程就会通知`TCP`释放连接。这时B发出的连接释放报文段必须使`FIN = 1`。现假定B的序号为w\(在半关闭状态B可能又发送了一些数据\)。B还必须重复上次已经发送过的确认号`ack = u + 1`。这时，B就进入`LAST-ACK(最后确认状态)`，等待A的确认。
  4. 在收到B的释放连接报文段后，必须对此发出一个确认。在确认报文段中把`ACK`置1，确认号`ack = w + 1`，而自己的序号是`seq = u + 1(根据TCP标准，前面发送过的FIN报文段要消耗一个序号)`。然后经过时间等待计时器\(`TIME-WAIT`\)设置的时间2MSL后，A才进入到CLOSED状态。时间MSL叫做最长报文段寿命。

## 应用层

* 协议与端口

| 协议 | `FTP` | `Telnet` | `SMTP` | `DNS` | `TFTP` | `HTTP` | `HTTPS` | `DNMP` |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 端口 | 21 | 23 | 25 | 53 | 69 | 80 | 443 | 161 |

* `DNS`
  * 域名系统
  * 作为将域名和IP地址相互映射的一个分布式数据库。
  * 每一级域名长度的限制是63个字符，域名总长度则不能超过253个字符。
* `FTP`
  * 文件传输协议
  * 网络上进行文件传输的一套标准协议
  * 客户-服务器模式
  * 使用`TCP`数据报
  * 提供交互式访问
  * 双向传输
* `TFTP`
  * 简单文件传输协议
  * 客户-服务器模式
  * 使用`UDP`数据报
  * 只支持文件传输而不支持交互
  * 不能对用户进行身份鉴定
* `Telnet`

