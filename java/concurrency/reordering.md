# 重排序

目的：在不改变程序执行结果的前提下，尽可能提高并行度。

为了提高性能，编译器和处理器常常会对指令进行重排序，分三种：

* `源代码` → `编译器优化重排序` → `指令级并行重排序` → `内存系统重排序` → `最终执行的指令序列`
* `编译器优化的重排序`：编译器在不改变单线程程序语义的前提下，可以重新安排语句的执行顺序。
* `指令级并行的重排序`：现代处理器采用了指令级并行技术来将多条指令重叠执行。如果不存在`数据依赖性`，处理器可以改变语句对应机器指令的执行顺序。
  * 如果两个操作访问同一个变量，且这两个操作有一个为写操作，此时这两个操作就存在`数据依赖性`这里就存在三种情况：
    * 读后写
    * 写后写
    * 写后读
* `内存系统的重排序`：由于处理器使用缓存和读/写缓冲区，这使得加载和存储操作看上去可能是在乱序执行的。

这些重排序会导致线程安全的问题，针对`编译器重排序`，JMM的编译器重排序规则禁止一些特定类型的编译器重排序。针对`处理器重排序`，编译器在生成指令序列的时候会通过插入内存屏障指令来禁止某些特殊的处理器重排序。

`as-if-serial`语义：不管怎么重排序\(编译器和处理器为了提供并行度\)，\(单线程\)程序的执行结果不能被改变。

